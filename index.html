<script type="module">
  // Load the Observable Runtime.
  import { Runtime } from "https://unpkg.com/@observablehq/notebook-runtime?module";
  const children = {};
  const renderNotebook = notebook => {
    log('loaded notebook:', notebook);
  
    // Load the notebook, and render any cells which start with two underscores: "__".
    document.body.innerHTML = '';
    Runtime.load(notebook, ({ name }) => {
      log('visited cell', name);
      if (name && name.startsWith('__')) {
        return {
          fulfilled: (value) => {
            if (value instanceof HTMLElement) {
              if (children[name]) {
                document.body.replaceChild(value, children[name]);
                log('replace:', name);
              } else {
                document.body.appendChild(value);
                log('append:', name);
              }
              
              children[name] = value;
            }
          }
        };
      }
    });
  }
  
  const getUrlParams = () => {
    var params = {};
    window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, (m, key, value) => params[key] = value);
    return params;
  }
  
  const urlParams = getUrlParams();
  const getUrlParam = (name, defaultValue) => urlParams[name] || defaultValue;

  
  // establish param based values
  const debug = getUrlParam('debug', false);
  const url = `https://api.observablehq.com/${getUrlParam('name', '@trebor')}/${getUrlParam('notebook', 'portfolio')}.js`;
  log('loading notebook:', url);
  
  import(url).then(module => renderNotebook(module.default));
  
  function log() {
    if (debug) {
      console.log.apply(this, arguments)
    }
  }
</script>
